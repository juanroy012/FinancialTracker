{% extends "base.html" %}

{% block title %}{{ title or "Edit Category" }}{% endblock %}

{% block content %}
<h1>{{ title or "Edit Category" }} #{{ category.id or category['id'] }}</h1>

{% if messages %}
  <ul class="flashes">
    {% for msg in messages %}
      <li class="error">{{ msg }}</li>
    {% endfor %}
  </ul>
{% endif %}

<div id="form-message" class="form-message" aria-live="polite"></div>

{# Edit existing category
   Why PATCH method: RESTful convention for partial updates
   form_data: User's attempted value if validation failed
   category: Current database value
#}
<form id="category-edit-form" data-category-id="{{ category.id or category['id'] }}" method="post" action="/category/{{ category.id or category['id'] }}">
  <label for="name">Category Name *
    <small>Current name: <strong>{{ category.name or category['name'] }}</strong></small>
  </label>
  <input 
    id="name" 
    name="name" 
    type="text" 
    maxlength="100"
    value="{{ form_data.name if form_data else (category.name or category['name']) }}" 
    required>
  
  <div class="form-actions">
    <button type="submit" class="btn-primary">üíæ Save Changes</button>
    <a href="/category" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<div class="info-box">
  <h3>‚ÑπÔ∏è About This Category</h3>
  <p><strong>ID:</strong> {{ category.id or category['id'] }}</p>
  <p><strong>Original Name:</strong> {{ category.name or category['name'] }}</p>
  <p class="note">‚ö†Ô∏è Changing the name will update all transactions using this category.</p>
</div>

<style>
  label small {
    display: block;
    font-weight: normal;
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .form-message {
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    background: #f1f3f5;
    color: #495057;
    display: none;
  }

  .form-message.success {
    display: block;
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    display: block;
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  /* Info box showing category details
     Why: Helps user confirm they're editing the right category */
  .info-box {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 4px;
    max-width: 600px;
  }
  
  .info-box h3 {
    margin-bottom: 1rem;
    color: #856404;
  }
  
  .info-box p {
    margin-bottom: 0.5rem;
  }
  
  .info-box .note {
    margin-top: 1rem;
    font-style: italic;
    color: #856404;
  }
</style>

<script>
  const form = document.getElementById("category-edit-form");
  const message = document.getElementById("form-message");
  const nameInput = document.getElementById("name");

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    message.textContent = "";
    message.className = "form-message";

    const name = nameInput.value.trim();
    if (!name) {
      message.textContent = "Name is required.";
      message.className = "form-message error";
      return;
    }

    const categoryId = form.dataset.categoryId;
    const response = await fetch(`/category/${categoryId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });

    if (!response.ok) {
      const errorText = await response.text();
      message.textContent = errorText || "Failed to update category.";
      message.className = "form-message error";
      return;
    }

    message.textContent = "Category updated.";
    message.className = "form-message success";
  });
</script>

{% endblock %}
